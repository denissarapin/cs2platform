{% extends "base.html" %}
{% block title %}Profile{% endblock %}
{% load static %}
{% block content %}
<style>
  .level-pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px; height: 36px;
    border-radius: 999px;
    background: #111827;
    color: #fbbf24;
    font-weight: 700;
    border: 1px solid rgba(255,255,255,0.1);
  }
  .level-icon { display:inline-block; vertical-align:middle; }
  .kpi {
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 14px;
  }
  .kpi h6 {
    margin: 0; font-weight: 600; opacity: .7;
  }
  .kpi .value {
    font-size: 1.4rem; font-weight: 800; line-height: 1.2;
  }
  .badge-game {
    background: #0ea5e9; color: #fff; border-radius: 999px; padding: .25rem .6rem; font-size: .75rem;
  }
  .faceit-header .nickname {
    font-size: 1.1rem; font-weight: 700;
  }
  .btn-soft {
    border: 1px solid rgba(0,0,0,.08);
  }
  .toggle-chev{display:inline-block;transition:transform .2s ease}
  .toggle-btn[aria-expanded="true"] .toggle-chev{transform:rotate(180deg)}
</style>
<div class="container my-5">
  <div class="card card-dark card-ring shadow-sm p-4 mb-4">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
      <div>
        <div class="h3 mb-1 text-white">{{ user.username }}</div>
        <div class="text-white-50">{{ user.email }}</div>
      </div>
      {% if faceit %}
        <div class="text-md-end">
          <div class="small text-white-50">Current Faceit game</div>
          <div class="h5 mb-0 text-white">{{ faceit.game|default:"CS2"|upper }}</div>
        </div>
      {% endif %}
    </div>
  </div>
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card card-dark card-ring shadow-sm h-100">
        <div class="card-body">
          <h5 class="mb-3 text-white">ðŸŽ® Steam Profile</h5>
          {% if steam %}
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="d-flex align-items-center gap-3">
                {% if steam.avatar %}
                  <img src="{{ steam.avatar }}" alt="" width="42" height="42" class="rounded-circle">
                {% endif %}
                <div>
                  <div class="fw-bold">
                    <a href="{{ steam.url }}" target="_blank" rel="noopener" class="text-white text-decoration-none">
                      {{ steam.name|default:"Steam Profile" }}
                    </a>
                    {% if steam.source == "manual" %}
                      <span class="badge bg-info ms-2">manually entered</span>
                    {% endif %}
                  </div>
                  <div class="text-white-50 small">ID: <span id="steamIdText">{{ steam.id }}</span></div>
                </div>
              </div>
              <button class="btn btn-outline-light btn-sm" id="copySteamBtn" type="button">Copy ID</button>
            </div>
            {% if user.steam_id %}
              <a href="{% url 'steam_disconnect' %}" class="btn btn-outline-danger w-100 mt-2">ðŸšª Disconnect Steam</a>
            {% endif %}
          {% else %}
            {% if user.steam_id %}
              <div class="mb-2 text-white"><b>Steam ID:</b> <span id="steamIdText">{{ user.steam_id }}</span></div>
              <a href="https://steamcommunity.com/profiles/{{ user.steam_id }}" target="_blank" rel="noopener" class="btn btn-outline-light btn-sm">ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð² Steam â†—</a>
              <a href="{% url 'steam_disconnect' %}" class="btn btn-outline-danger w-100 mt-2">ðŸšª Disconnect Steam</a>
            {% else %}
              <p class="text-white-50">Connect Steam so we can find your Faceit account.</p>
              <a href="{% url 'connect_steam' %}" class="btn btn-outline-light w-100">ðŸ”— Connect Steam</a>
            {% endif %}
          {% endif %}
          <hr class="my-3 border-secondary">
          <form method="post" action="{% url 'profile' %}" class="mt-2">
            {% csrf_token %}
            <label class="form-label mb-1 text-white-50">Enter SteamID64, link, or alias</label>
            <div class="input-group">
              {{ lookup_form.steam_id }}
              <button class="btn btn-primary" type="submit">Find Faceit</button>
            </div>
            {% if lookup_form.steam_id.errors %}
              <div class="text-danger small mt-2">{{ lookup_form.steam_id.errors.0 }}</div>
            {% endif %}
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-8">
      <div class="card card-dark card-ring shadow-sm h-100">
        <div class="card-body">
          <h5 class="mb-3 text-white">ðŸŸ  Faceit</h5>
          {% if faceit %}
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="d-flex align-items-center gap-3">
                {% if faceit.avatar %}
                  <img src="{{ faceit.avatar }}" alt="" width="56" height="56" class="rounded-circle">
                {% else %}
                  <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center" style="width:56px;height:56px;">ðŸ‘¤</div>
                {% endif %}
                <div>
                  <div class="nickname">
                    <a href="https://www.faceit.com/en/players/{{ faceit.nickname }}"
                       class="text-white text-decoration-none" target="_blank" rel="noopener">
                      {{ faceit.nickname }}
                    </a>
                  </div>
                  <div class="d-flex align-items-center gap-2 mt-1">
                    {% with lvl=faceit.level|default:0 %}
                      {% if lvl %}
                        <img
                          src="{% static 'img/faceit/levels/skill_level_' %}{{ lvl }}.png"
                          alt="Faceit Level {{ lvl }}"
                          width="35" height="35"
                          class="level-icon"
                          loading="lazy">
                      {% else %}
                        <span class="badge bg-secondary">LVL â€”</span>
                      {% endif %}
                    {% endwith %}
                    <span class="badge-game">{{ faceit.game|default:"CS2"|upper }}</span>
                  </div>
                </div>
              </div>
              <div class="text-end">
                <div class="small text-white-50">ELO</div>
                <div class="display-6 mb-0 text-white" style="font-size:2rem;">{{ faceit.elo|default:"â€”" }}</div>
                <a href="https://www.faceit.com/en/players/{{ faceit.nickname }}"
                   class="btn btn-open-faceit btn-sm mt-2" target="_blank" rel="noopener">Open on Faceit â†—</a>
              </div>
            </div>
            {% if faceit.lifetime %}
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <div class="p-3 kpi kpi-dark">
                    <h6 class="text-white-50">Matches</h6>
                    <div class="value text-white">{{ faceit.lifetime.matches|default:"â€”" }}</div>
                  </div>
                </div>
                <div class="col-12 col-md-4">
                  <div class="p-3 kpi kpi-dark">
                    <h6 class="text-white-50">Average K/D</h6>
                    <div class="value text-white">{{ faceit.lifetime.kd_avg|floatformat:2|default:"â€”" }}</div>
                  </div>
                </div>
                <div class="col-12 col-md-4">
                  <div class="p-3 kpi kpi-dark">
                    <h6 class="text-white-50">Win Rate</h6>
                    <div class="value text-white">{{ faceit.lifetime.winrate|floatformat:1|default:"â€”" }}%</div>
                    {% with wr=faceit.lifetime.winrate|default:0 %}
                      <div class="progress mt-2" style="height:8px;">
                        <div class="progress-bar" style="width: {{ wr }}%;" role="progressbar"
                             aria-valuenow="{{ wr }}" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    {% endwith %}
                  </div>
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="text-white-50">
              {% if faceit_error %}{{ faceit_error }}{% else %}
                Connect Steam
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% if faceit and faceit.maps %}
  <div class="row g-4 mt-1">
    <div class="col-12" id="mapsCard">
      <div class="card card-dark card-ring shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="mb-0 text-white">Map statistics</h5>
            <div class="d-flex align-items-center gap-2">
              <div class="input-group input-group-sm" style="width: 260px;">
                <label class="input-group-text" for="mapsSort">Sort by</label>
                <select id="mapsSort" class="form-select">
                  <option value="matches">Matches</option>
                  <option value="winrate">Win Rate</option>
                  <option value="kd">K/D</option>
                </select>
                <button class="btn btn-outline-light" id="mapsOrderBtn" type="button" title="Order">â†“</button>
              </div>
              <button class="btn btn-outline-light btn-sm toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#mapsCollapseWide" aria-expanded="false" aria-controls="mapsCollapseWide">
                Show / hide <span class="toggle-chev ms-1">â–¾</span>
              </button>
            </div>
          </div>
          <div class="collapse mt-3" id="mapsCollapseWide">
            <div class="row g-3 maps-grid">
              {% for m in faceit.maps %}
                <div class="col-12 col-md-6 col-lg-4"
                     data-matches="{{ m.matches|default:0 }}"
                     data-winrate="{{ m.winrate|default:0 }}"
                     data-kd="{{ m.kd|default:0 }}">
                  <div class="p-3 kpi kpi-dark">
                    <div class="d-flex align-items-center justify-content-between mb-1">
                      <span class="fw-bold text-white">{{ m.name }}</span>
                      {% if m.winrate %}
                        <span class="badge bg-secondary text-white">{{ m.winrate|floatformat:0 }}%</span>
                      {% endif %}
                    </div>
                    <div class="small text-white-50">Matches: <b class="text-white">{{ m.matches }}</b></div>
                    <div class="small text-white-50">K/D: <b class="text-white">{{ m.kd|floatformat:2|default:"â€”" }}</b></div>
                    {% if m.winrate %}
                      <div class="progress mt-2" style="height:6px;">
                        {% with wr=m.winrate|default:0 %}
                          <div class="progress-bar {% if wr < 45 %}bg-danger{% elif wr > 55 %}bg-success{% else %}bg-warning{% endif %}"
                               style="width: {{ wr }}%;"
                               role="progressbar"
                               aria-valuenow="{{ wr|floatformat:0 }}"
                               aria-valuemin="0" aria-valuemax="100"></div>
                        {% endwith %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
<script>(() => {
  const btn = document.getElementById('copySteamBtn');
  const el  = document.getElementById('steamIdText');
  if (!btn || !el) return;

  btn.addEventListener('click', async () => {
    const text = el.textContent.trim();
    try {
      await navigator.clipboard.writeText(text);
      btn.textContent = 'Copied';
    } catch {
      const r = document.createRange(); r.selectNode(el);
      const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(r);
      document.execCommand('copy'); sel.removeAllRanges();
      btn.textContent = 'Copied';
    }
    setTimeout(() => btn.textContent = 'Copy ID', 1500);
  });
})();

(() => {
  const KEY_EXP   = 'faceit:maps:expanded';
  const KEY_SORT  = 'faceit:maps:sort';
  const KEY_ORDER = 'faceit:maps:order';
  const COLLAPSE_ID = 'mapsCollapseWide';
  const collapseEl = document.getElementById(COLLAPSE_ID);
  const toggleBtn  = document.querySelector(`.toggle-btn[data-bs-target="#${COLLAPSE_ID}"]`);
  const grid       = document.querySelector(`#${COLLAPSE_ID} .maps-grid`);
  const sortSel    = document.getElementById('mapsSort');
  const orderBtn   = document.getElementById('mapsOrderBtn');
  if (!grid || !sortSel || !orderBtn) return;

  if (collapseEl && toggleBtn) {
    const setToggleLabel = (exp) => {
      toggleBtn.innerHTML = (exp ? 'Hide ' : 'Show ')
        + '<span class="d-none d-sm-inline">statistics</span><span class="toggle-chev ms-1">â–¾</span>';
      toggleBtn.setAttribute('aria-expanded', String(exp));
    };

    const savedExp = localStorage.getItem(KEY_EXP) === 'true';
    if (savedExp) collapseEl.classList.add('show');
    setToggleLabel(savedExp);
    collapseEl.addEventListener('shown.bs.collapse',  () => { localStorage.setItem(KEY_EXP,'true');  setToggleLabel(true);  });
    collapseEl.addEventListener('hidden.bs.collapse', () => { localStorage.setItem(KEY_EXP,'false'); setToggleLabel(false); });
  }

  const savedSort  = localStorage.getItem(KEY_SORT)  || 'matches';
  const savedOrder = localStorage.getItem(KEY_ORDER) || 'desc';
  sortSel.value = savedSort;
  orderBtn.dataset.order = savedOrder;
  orderBtn.textContent   = savedOrder === 'asc' ? 'â†‘' : 'â†“';

  const getVal = (el, key) => {
    const v = parseFloat(el.dataset[key]);
    return Number.isFinite(v) ? v : -Infinity;
  };

  function sortGrid() {
    const key   = sortSel.value;
    const order = orderBtn.dataset.order || 'desc';
    const items = Array.from(grid.children);

    items.sort((a, b) => {
      const va = getVal(a, key), vb = getVal(b, key);
      return order === 'asc' ? (va - vb) : (vb - va);
    });

    items.forEach(el => grid.appendChild(el));
    localStorage.setItem(KEY_SORT,  key);
    localStorage.setItem(KEY_ORDER, order);
  }

  sortSel.addEventListener('change', sortGrid);
  orderBtn.addEventListener('click', () => {
    orderBtn.dataset.order = (orderBtn.dataset.order === 'asc') ? 'desc' : 'asc';
    orderBtn.textContent   = orderBtn.dataset.order === 'asc' ? 'â†‘' : 'â†“';
    sortGrid();
  });

  sortGrid();
})();
</script>
{% endblock %}
